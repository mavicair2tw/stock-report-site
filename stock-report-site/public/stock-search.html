<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>股市 Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>body{background:#0b1020;color:#e5e7eb}</style>
</head>
<body class="min-h-screen">
  <main class="max-w-7xl mx-auto p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-bold">股市 Search</h1>
      <a href="/" class="text-sky-300 hover:underline">返回首頁</a>
    </div>

    <section class="bg-slate-900 border border-slate-700 rounded-xl p-4 mb-4">
      <div class="relative">
        <input id="q" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-3 text-slate-100" placeholder="輸入股票代號 (AAPL, NVDA, TSLA...)" value="AAPL" />
        <div id="suggest" class="absolute z-20 mt-2 w-full bg-slate-900 border border-slate-700 rounded-lg overflow-hidden hidden"></div>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mt-4 text-sm" id="meta"></div>
      <div class="flex flex-wrap gap-2 mt-4" id="ranges"></div>
      <div id="err" class="text-red-400 mt-3 text-sm"></div>
    </section>

    <section class="bg-slate-900 border border-slate-700 rounded-xl p-2">
      <div id="loading" class="p-3 text-slate-400 hidden">載入中...</div>
      <div id="chart" style="height:460px"></div>
    </section>
  </main>

<script>
const RANGES={ '1D':['1d','5m'],'5D':['5d','15m'],'1M':['1mo','1d'],'3M':['3mo','1d'],'1Y':['1y','1d'],'5Y':['5y','1wk']};
let symbol='AAPL', range='1M', candles=[];
const chartEl=document.getElementById('chart');
const qEl=document.getElementById('q');
const suggestEl=document.getElementById('suggest');
const metaEl=document.getElementById('meta');
const errEl=document.getElementById('err');
const loadingEl=document.getElementById('loading');
let chart;

function fmtNum(v){ return v==null?'N/A':Number(v).toLocaleString(); }
function fmtPct(v){ return v==null?'N/A':`${v>=0?'+':''}${Number(v).toFixed(2)}%`; }
function fmtCap(v){ if(v==null)return 'N/A'; const n=Number(v); if(n>=1e12)return (n/1e12).toFixed(2)+'T'; if(n>=1e9)return (n/1e9).toFixed(2)+'B'; return fmtNum(n); }
function info(label,val,cls='text-slate-100'){ return `<div class='bg-slate-800 rounded-lg p-3 border border-slate-700'><div class='text-slate-400'>${label}</div><div class='font-semibold ${cls}'>${val}</div></div>`; }
function ma(len){ const out=[]; for(let i=0;i<candles.length;i++){ if(i<len-1) continue; let s=0; for(let j=i-len+1;j<=i;j++) s+=candles[j].close; out.push({time:candles[i].time,value:s/len}); } return out; }

function showErr(msg=''){ errEl.textContent=msg; }
function setLoading(v){ loadingEl.classList.toggle('hidden', !v); }

async function fetchJson(url){
  // prefer direct
  try { const r=await fetch(url); if(r.ok) return await r.json(); } catch {}
  // proxy fallback
  const p='https://r.jina.ai/http://'+url.replace(/^https?:\/\//,'');
  const r2=await fetch(p); if(!r2.ok) throw new Error('fetch failed');
  const t=await r2.text();
  const s=t.indexOf('{'), e=t.lastIndexOf('}');
  if(s<0||e<=s) throw new Error('invalid payload');
  return JSON.parse(t.slice(s,e+1));
}

async function searchSuggest(q){
  if(!q) return [];
  try{
    const u=`https://query1.finance.yahoo.com/v1/finance/search?q=${encodeURIComponent(q)}&lang=en-US&region=US&quotesCount=8&newsCount=0`;
    const d=await fetchJson(u);
    return (d.quotes||[]).filter(x=>x.symbol&&x.shortname).slice(0,8).map(x=>({symbol:x.symbol,name:x.shortname}));
  }catch{return []}
}

function renderChart(){
  if(chart) chart.remove();
  chart=LightweightCharts.createChart(chartEl,{layout:{background:{color:'#0f172a'},textColor:'#cbd5e1'},grid:{vertLines:{color:'#1e293b'},horzLines:{color:'#1e293b'}},rightPriceScale:{borderColor:'#334155'},timeScale:{borderColor:'#334155'},width:chartEl.clientWidth,height:460});
  const cs=chart.addCandlestickSeries({upColor:'#22c55e',downColor:'#ef4444',borderVisible:false,wickUpColor:'#22c55e',wickDownColor:'#ef4444'});
  cs.setData(candles.map(x=>({time:x.time,open:x.open,high:x.high,low:x.low,close:x.close})));
  const vol=chart.addHistogramSeries({priceFormat:{type:'volume'},priceScaleId:''});
  vol.priceScale().applyOptions({scaleMargins:{top:0.8,bottom:0}});
  vol.setData(candles.map(x=>({time:x.time,value:x.volume||0,color:x.close>=x.open?'rgba(34,197,94,.5)':'rgba(239,68,68,.5)'})));
  chart.addLineSeries({color:'#60a5fa',lineWidth:2,title:'MA5'}).setData(ma(5));
  chart.addLineSeries({color:'#f59e0b',lineWidth:2,title:'MA20'}).setData(ma(20));
  chart.addLineSeries({color:'#a78bfa',lineWidth:2,title:'MA60'}).setData(ma(60));
  chart.timeScale().fitContent();
}

async function load(){
  showErr(''); setLoading(true);
  try{
    const [r,iv]=RANGES[range];
    const chartUrl=`https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?range=${r}&interval=${iv}`;
    const quoteUrl=`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(symbol)}`;
    const [cj,qj]=await Promise.all([fetchJson(chartUrl),fetchJson(quoteUrl)]);
    const q=qj?.quoteResponse?.result?.[0]||{};
    metaEl.innerHTML=[
      info('公司', q.shortName||q.longName||symbol),
      info('價格', q.regularMarketPrice??'N/A'),
      info('漲跌幅', fmtPct(q.regularMarketChangePercent), q.regularMarketChangePercent>=0?'text-emerald-400':'text-red-400'),
      info('成交量', fmtNum(q.regularMarketVolume)),
      info('市值', fmtCap(q.marketCap))
    ].join('');

    const rs=cj?.chart?.result?.[0];
    const ts=rs?.timestamp||[]; const qq=rs?.indicators?.quote?.[0]||{};
    candles=ts.map((t,i)=>({time:t,open:qq.open?.[i],high:qq.high?.[i],low:qq.low?.[i],close:qq.close?.[i],volume:qq.volume?.[i]})).filter(x=>[x.open,x.high,x.low,x.close].every(n=>Number.isFinite(n)));
    if(!candles.length) throw new Error('查無可用K線資料');
    renderChart();
  }catch(e){
    showErr('資料讀取失敗，請換股票代號或稍後再試。');
    metaEl.innerHTML=[info('公司',symbol),info('價格','N/A'),info('漲跌幅','N/A'),info('成交量','N/A'),info('市值','N/A')].join('');
  }finally{ setLoading(false); }
}

function initRanges(){
  const wrap=document.getElementById('ranges');
  wrap.innerHTML='';
  Object.keys(RANGES).forEach(k=>{
    const b=document.createElement('button');
    b.textContent=k;
    b.className='px-3 py-1 rounded-lg border '+(k===range?'bg-sky-600 border-sky-400':'bg-slate-800 border-slate-600');
    b.onclick=()=>{ range=k; initRanges(); load(); };
    wrap.appendChild(b);
  });
}

let t;
qEl.addEventListener('input',()=>{
  clearTimeout(t);
  t=setTimeout(async()=>{
    const s=await searchSuggest(qEl.value.trim());
    if(!s.length){ suggestEl.classList.add('hidden'); suggestEl.innerHTML=''; return; }
    suggestEl.innerHTML=s.map(x=>`<button data-s='${x.symbol}' class='w-full text-left px-4 py-2 hover:bg-slate-800'><span class='font-semibold mr-2'>${x.symbol}</span><span class='text-slate-400'>${x.name}</span></button>`).join('');
    suggestEl.classList.remove('hidden');
    suggestEl.querySelectorAll('button').forEach(b=>b.onclick=()=>{ symbol=b.dataset.s; qEl.value=symbol; suggestEl.classList.add('hidden'); load(); });
  },220);
});
qEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ symbol=qEl.value.trim().toUpperCase()||'AAPL'; suggestEl.classList.add('hidden'); load(); }});
window.addEventListener('resize',()=>{ if(chart) chart.applyOptions({width:chartEl.clientWidth}); });

initRanges();
load();
</script>
</body>
</html>
