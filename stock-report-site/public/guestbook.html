<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat</title>
    <style>
      :root { --bg:#0b1020; --panel:#121a2f; --line:#1f2a44; --text:#e6edf3; --muted:#9fb0c3; --accent:#60a5fa; }
      *{box-sizing:border-box}
      body{margin:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0a1226 100%);color:var(--text)}
      .wrap{max-width:1000px;margin:0 auto}
      .top-bar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
      .logo{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;border:1px solid #2a3a5e;background:#101a33;color:#dbeafe;font-weight:800;font-size:13px}
      .top-tags{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px}
      .nav-item{display:flex;flex-direction:column;gap:4px;align-items:flex-start}
      .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2a3a5e;color:#cfe2ff;text-decoration:none;font-size:12px;font-weight:700}
      .tag-sub{color:#8fa3bf;font-size:11px;line-height:1;padding-left:8px}
      .tag.active{border-color:#60a5fa;background:#1a315f;color:#fff}
      .sub{color:var(--muted);margin-bottom:12px}
      .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;line-height:1.7;margin-bottom:12px}
      .chat-box{height:420px;overflow:auto;padding:12px;border-radius:10px;background:#0f1730;border:1px solid #223055}
      .msg{margin:10px 0;display:flex}
      .msg.user{justify-content:flex-end}
      .bubble{max-width:78%;padding:10px 12px;border-radius:12px;white-space:pre-wrap;line-height:1.5}
      .msg.user .bubble{background:#1e3a6b;color:#dbeafe}
      .msg.bot .bubble{background:#1b243f;color:#e6edf3;border:1px solid #2a365c}
      .row{display:flex;gap:8px;margin-top:10px}
      textarea{flex:1;min-height:64px;max-height:180px;background:#0f1730;color:var(--text);border:1px solid #223055;border-radius:10px;padding:10px;resize:vertical}
      button{padding:10px 14px;border-radius:10px;border:1px solid #35558d;background:#1a315f;color:#fff;font-weight:700;cursor:pointer}
      button:disabled{opacity:.6;cursor:not-allowed}
      .btn-ghost{background:transparent;border-color:#2b3b5f;color:#bcd0ef}
      .hint{font-size:12px;color:var(--muted);margin-top:8px}
      .error{font-size:12px;color:#fca5a5;margin-top:8px;min-height:18px}
      .site-link{margin-top:18px;color:var(--muted);font-size:13px}
      .site-link a{color:#93c5fd;text-decoration:none}
      .site-link a:hover{text-decoration:underline}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top-bar">
        <div class="logo">openai-tw.com</div>
        <div class="top-tags">
          <div class="nav-item"><a class="tag" href="/">Home</a><span class="tag-sub">Main Portal</span></div>
          <div class="nav-item"><a class="tag" href="/tw/">台股</a><span class="tag-sub">TW Market</span></div>
          <div class="nav-item"><a class="tag" href="/us/">美股</a><span class="tag-sub">US Market</span></div>
          <div class="nav-item"><a class="tag active" href="/guestbook/">Chat</a><span class="tag-sub">Guestbook</span></div>
        </div>
      </div>

      <h1>Chat</h1>
      <div class="sub">網站內嵌聊天（Cloudflare Worker + ChatGPT）</div>

      <div class="card">
        <div id="chat" class="chat-box"></div>
        <div class="row">
          <textarea id="input" placeholder="輸入訊息，Shift+Enter 換行，Enter 送出"></textarea>
          <button id="send">送出</button>
          <button id="clear" class="btn-ghost" type="button">清除</button>
        </div>
        <div class="hint">若出現錯誤，請確認 Cloudflare Worker 已部署且已設定 OPENAI_API_KEY（目前走 workers.dev 端點）。</div>
        <div class="error" id="error"></div>
      </div>

      <div class="site-link"><a href="https://openai-tw.com/">openai-tw.com</a></div>
    </div>

    <script>
      const chatEl = document.getElementById('chat');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');
      const clearBtn = document.getElementById('clear');
      const errorEl = document.getElementById('error');
      const STORAGE_KEY = 'openai-tw-chat-history-v1';
      const history = [];

      function setError(msg = '') { errorEl.textContent = msg; }

      function saveHistory(){
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history.slice(-40)));
      }

      function loadHistory(){
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if(!raw) return;
          const arr = JSON.parse(raw);
          if(!Array.isArray(arr)) return;
          history.push(...arr.filter(m => m && typeof m.content === 'string' && (m.role === 'user' || m.role === 'assistant')));
        } catch {}
      }

      function addMsg(role, text){
        const wrap = document.createElement('div');
        wrap.className = `msg ${role === 'user' ? 'user' : 'bot'}`;
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.textContent = text;
        wrap.appendChild(bubble);
        chatEl.appendChild(wrap);
        chatEl.scrollTop = chatEl.scrollHeight;
      }

      function rerender(){
        chatEl.innerHTML = '';
        if(!history.length){
          addMsg('bot', '嗨，我是你的 Chat 助手。');
          return;
        }
        history.forEach(m => addMsg(m.role === 'user' ? 'user' : 'bot', m.content));
      }

      loadHistory();
      rerender();

      function explainError(status, fallback){
        if(status === 404) return 'API 路徑不存在：請設定 Worker Route（openai-tw.com/api/*）。';
        if(status === 401 || status === 403) return 'API 金鑰驗證失敗：請檢查 OPENAI_API_KEY。';
        if(status === 429) return '請求過多：已觸發限流，請稍後再試。';
        if(status >= 500) return '伺服器暫時異常，請稍後再試。';
        return fallback || '連線失敗，請稍後再試。';
      }

      async function send(){
        const text = inputEl.value.trim();
        if(!text) return;
        setError('');
        inputEl.value = '';
        history.push({ role:'user', content:text });
        addMsg('user', text);
        saveHistory();

        const loading = document.createElement('div');
        loading.className = 'msg bot';
        loading.innerHTML = '<div class="bubble">思考中…</div>';
        chatEl.appendChild(loading);
        chatEl.scrollTop = chatEl.scrollHeight;
        sendBtn.disabled = true;

        try {
          const res = await fetch('https://openai-tw-chat.googselect.workers.dev/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: history })
          });
          const data = await res.json().catch(() => ({}));
          loading.remove();

          if(!res.ok){
            setError(explainError(res.status, data?.error));
            addMsg('bot', `⚠️ ${explainError(res.status, data?.error)}`);
            return;
          }

          const reply = data?.reply || '（沒有回覆內容）';
          history.push({ role:'assistant', content: reply });
          addMsg('bot', reply);
          saveHistory();
        } catch (e) {
          loading.remove();
          const msg = '連線失敗，請稍後再試。';
          setError(msg);
          addMsg('bot', `⚠️ ${msg}`);
        } finally {
          sendBtn.disabled = false;
          inputEl.focus();
        }
      }

      clearBtn.addEventListener('click', () => {
        history.length = 0;
        localStorage.removeItem(STORAGE_KEY);
        setError('');
        rerender();
      });

      sendBtn.addEventListener('click', send);
      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          send();
        }
      });
    </script>
  </body>
</html>
