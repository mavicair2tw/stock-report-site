<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>每日盤後新聞摘要</title>
    <style>
      :root { --bg:#0b1020; --panel:#121a2f; --line:#1f2a44; --text:#e6edf3; --muted:#9fb0c3; --green:#22c55e; --red:#ef4444; }
      *{box-sizing:border-box}
      body{margin:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0a1226 100%);color:var(--text)}
      .wrap{max-width:1000px;margin:0 auto}
      h1{margin:0 0 8px}
      .sub{color:var(--muted);margin-bottom:14px}
      .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:12px;line-height:1.7}
      .up{color:var(--green)} .down{color:var(--red)} .muted{color:var(--muted)}
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>每日盤後新聞摘要（新 Tag）</h1>
      <div class="sub" id="updated">載入中...</div>
      <div class="card" id="twNews">載入台股摘要...</div>
      <div class="card" id="usNews">載入美股摘要...</div>
      <div class="card" id="btcNews">載入 BTC 摘要...</div>
    </div>

    <script>
      function cls(v){ if(v>0) return 'up'; if(v<0) return 'down'; return ''; }

      function twSummary(items, ts){
        const valid = (items||[]).filter(i=>typeof i.changePercent==='number');
        if(!valid.length) return '台股：資料不足。';
        const avg = valid.reduce((a,b)=>a+b.changePercent,0)/valid.length;
        const top = valid.slice().sort((a,b)=>b.changePercent-a.changePercent)[0];
        const low = valid.slice().sort((a,b)=>a.changePercent-b.changePercent)[0];
        return `【台股】<br>• ${ts} 盤後平均漲跌幅 <span class="${cls(avg)}">${avg.toFixed(2)}%</span><br>• 強勢：<span class="up">${top.label} ${top.changePercent}%</span>；弱勢：<span class="down">${low.label} ${low.changePercent}%</span><br>• 建議：分批布局、嚴守停損。`;
      }

      function usSummary(items, ts){
        const valid = (items||[]).filter(i=>typeof i.changePercent==='number');
        if(!valid.length) return '美股：資料不足。';
        const avg = valid.reduce((a,b)=>a+b.changePercent,0)/valid.length;
        const top = valid.slice().sort((a,b)=>b.changePercent-a.changePercent)[0];
        const low = valid.slice().sort((a,b)=>a.changePercent-b.changePercent)[0];
        return `【美股】<br>• ${ts} 盤後平均漲跌幅 <span class="${cls(avg)}">${avg.toFixed(2)}%</span><br>• 強勢：<span class="up">${top.label} ${top.changePercent}%</span>；弱勢：<span class="down">${low.label} ${low.changePercent}%</span><br>• 建議：留意財報與事件風險，分散配置。`;
      }

      function btcSummary(perf, ts){
        const valid = (perf||[]).filter(i=>typeof i.changePercent==='number');
        if(!valid.length) return 'BTC：資料不足。';
        const avg = valid.reduce((a,b)=>a+b.changePercent,0)/valid.length;
        const top = valid.slice().sort((a,b)=>b.changePercent-a.changePercent)[0];
        const low = valid.slice().sort((a,b)=>a.changePercent-b.changePercent)[0];
        return `【BTC】<br>• ${ts} 近 24h 每小時平均變動 <span class="${cls(avg)}">${avg.toFixed(3)}%</span><br>• 強勢時段：<span class="up">${top.time} ${top.changePercent}%</span>；弱勢時段：<span class="down">${low.time} ${low.changePercent}%</span><br>• 建議：小部位、控槓桿、先風控。`;
      }

      Promise.all([
        fetch('./tw/data/latest.json?ts='+Date.now()).then(r=>r.json()),
        fetch('./us/data/us_latest.json?ts='+Date.now()).then(r=>r.json()),
        fetch('./btc-hourly/data/latest.json?ts='+Date.now()).then(r=>r.json()),
      ]).then(([tw, us, btc]) => {
        const ts = (tw.updatedAt || us.updatedAt || btc.updatedAt || '').slice(0,16).replace('T',' ');
        document.getElementById('updated').textContent = `最後更新：${ts} (Asia/Taipei)`;
        document.getElementById('twNews').innerHTML = twSummary(tw.items, ts);
        document.getElementById('usNews').innerHTML = usSummary(us.items, ts);
        document.getElementById('btcNews').innerHTML = btcSummary(btc.performance24h, ts);
      }).catch(() => {
        document.getElementById('updated').textContent = '載入失敗，請稍後重整';
      });
    </script>
  </body>
</html>
