<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>健康分級與就醫建議系統</title>
  <style>
    :root{--bg:#0b1020;--panel:#121a2f;--line:#1f2a44;--text:#e6edf3;--muted:#9fb0c3}
    *{box-sizing:border-box}
    body{margin:20px;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0a1226 100%);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto}
    .top-bar{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .logo{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;border:1px solid #2a3a5e;background:#101a33;color:#dbeafe;font-weight:800;font-size:13px}
    .top-tags{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px}
    .nav-item{display:flex;flex-direction:column;gap:4px;align-items:flex-start}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2a3a5e;color:#cfe2ff;text-decoration:none;font-size:12px;font-weight:700}
    .tag-sub{color:#8fa3bf;font-size:11px;line-height:1;padding-left:8px}
    .tag.active{border-color:#60a5fa;background:#1a315f;color:#fff}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px;line-height:1.6;margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width: 700px){.row{grid-template-columns:1fr}}
    label{font-size:12px;color:#b9cae6;display:flex;flex-direction:column;gap:6px}
    input,select,textarea,button{background:#0f1730;color:#e6edf3;border:1px solid #223055;border-radius:8px;padding:8px}
    textarea{min-height:72px}
    button{cursor:pointer}
    .sub{color:var(--muted)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{border:1px solid #2a3a5e;border-radius:999px;padding:5px 10px;font-size:12px;background:#0f1730}
    .section-title{margin:0 0 8px;font-size:16px}
    .result-level{font-size:20px;font-weight:800}
    .lv1{color:#fca5a5}.lv2{color:#fdba74}.lv3{color:#fde68a}.lv4{color:#86efac}
    .site-link{margin-top:18px;color:var(--muted);font-size:13px}
    .site-link a{color:#93c5fd;text-decoration:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top-bar">
    <div class="logo">openai-tw.com</div>
    <div class="top-tags">
      <div class="nav-item"><a class="tag" href="/">Home</a><span class="tag-sub">Main Portal</span></div>
      <div class="nav-item"><a class="tag active" href="/health-triage/">健康分級</a><span class="tag-sub">Triage</span></div>
      <form action="/search/" method="get" style="display:flex;gap:8px;align-items:center;">
        <input name="q" type="text" placeholder="Search keyword..." style="width:220px;max-width:42vw;background:#0f1730;color:#e6edf3;border:1px solid #223055;border-radius:999px;padding:6px 10px;font-size:12px;" />
        <button type="submit" style="padding:6px 10px;border-radius:999px;border:1px solid #35558d;background:#1a315f;color:#fff;font-size:12px;font-weight:700;cursor:pointer;">Search</button>
      </form>
    </div>
  </div>

  <h1>健康勾選 → 風險分級 → 飲食注意 → 建議就醫科別</h1>
  <div class="sub">可直接作為 Web/App 規則引擎原型（繁中）。</div>

  <div class="card">
    <h3 class="section-title">1) 基本資料與生命徵象</h3>
    <div class="row">
      <label>年齡<input id="age" type="number" min="0" max="120" /></label>
      <label>性別<select id="gender"><option value="">未填</option><option>男</option><option>女</option></select></label>
      <label>懷孕/生理期<select id="preg"><option value="none">無</option><option value="period">生理期</option><option value="pregnancy">懷孕</option></select></label>
      <label>體溫 (°C)<input id="temp" type="number" step="0.1" /></label>
      <label>心率 (bpm)<input id="hr" type="number" /></label>
      <label>血氧 SpO2 (%)<input id="spo2" type="number" /></label>
    </div>
    <div class="row" style="margin-top:10px">
      <label>用藥<input id="meds" placeholder="例：抗凝血藥" /></label>
      <label>過敏<input id="allergy" placeholder="例：青黴素" /></label>
      <label>補充說明<textarea id="note" placeholder="補充描述：是否加重、發燒、食慾、脫水等"></textarea></label>
    </div>
    <div style="margin-top:10px">
      <div class="sub" style="margin-bottom:6px">背景風險（Comorbidity IDs）</div>
      <div id="comorbids" class="chips"></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 class="section-title">2A) 紅旗警訊（任一命中 -> Level 1）</h3>
      <div id="redFlags" class="chips"></div>
    </div>
    <div class="card">
      <h3 class="section-title">2B) 病徵分群（一般分級）</h3>
      <div id="symptoms" class="chips"></div>
      <label style="margin-top:10px">程度
        <select id="severity"><option value="1">輕</option><option value="2" selected>中</option><option value="3">重</option></select>
      </label>
      <label>多久了
        <select id="duration"><option value="1"><24h</option><option value="2">1-3天</option><option value="3">4-14天</option><option value="4">>2週</option></select>
      </label>
    </div>
  </div>

  <div class="card"><button id="runBtn">產生分級與建議</button> <span id="status" class="sub"></span></div>

  <div class="grid">
    <div class="card" id="r1"><h3 class="section-title">卡片1：風險分級</h3><div class="sub">尚未分析</div></div>
    <div class="card" id="r2"><h3 class="section-title">卡片2：建議就醫科別</h3><div class="sub">尚未分析</div></div>
    <div class="card" id="r3"><h3 class="section-title">卡片3：飲食注意</h3><div class="sub">尚未分析</div></div>
    <div class="card" id="r4"><h3 class="section-title">卡片4：觀察清單</h3><div class="sub">尚未分析</div></div>
  </div>

  <div class="card sub">
    安全與免責：本系統提供健康資訊與就醫建議，不取代醫師診斷。若出現紅旗警訊或症狀快速惡化，請立即就醫/急診。
  </div>

  <div class="site-link"><a href="https://openai-tw.com/">openai-tw.com</a></div>
</div>

<script>
const RULES_CONFIG = {
  symptomDict: {
    S_CHEST_PAIN:'胸痛/胸悶', S_SOB:'呼吸困難/喘', S_FAINT:'昏厥/意識改變', S_STROKE_SIGN:'口齒不清/單側無力/視力突變',
    S_FEVER:'發燒', S_COUGH:'咳嗽', S_SORE_THROAT:'喉嚨痛', S_RUNNY_NOSE:'流鼻水/鼻塞',
    S_NAUSEA:'噁心', S_VOMIT:'嘔吐', S_DIARRHEA:'腹瀉', S_CONSTIPATION:'便秘', S_ABD_PAIN:'腹痛', S_BLACK_STOOL:'黑便/血便',
    S_DIZZINESS:'頭暈/眩暈', S_HEADACHE:'頭痛', S_NUMBNESS:'麻木刺痛', S_PALPITATION:'心悸',
    S_RASH:'皮疹/蕁麻疹', S_URINE_PAIN:'排尿疼痛', S_BLOOD_URINE:'血尿', S_BACK_FLANK_PAIN:'腰/肋側痛',
    S_JOINT_SWELL:'關節腫痛', S_LOWER_BACK_PAIN:'下背痛/坐骨痛', S_SLEEP_ISSUE:'失眠', S_ANXIETY:'焦慮/恐慌'
  },
  comorbDict: {
    C_HTN:'高血壓', C_DM:'糖尿病', C_CAD:'心臟病/冠心症', C_CKD:'腎臟病', C_LIVER:'肝病', C_ASTHMA:'氣喘/COPD',
    C_GERD:'胃食道逆流/胃潰瘍', C_ANTICOAG:'抗凝血/抗血小板', C_PREG:'懷孕/疑似懷孕', C_IMMUNO:'免疫低下', C_AGE65P:'65歲以上', C_AGE5M:'5歲以下'
  },
  redFlagIds: ['S_CHEST_PAIN','S_SOB','S_FAINT','S_STROKE_SIGN','S_BLACK_STOOL'],
  levelRules: [
    {id:'L1_RED_FLAG', priority:100, when:{redFlag:true}, out:{level:1, reason:'命中紅旗警訊'}},
    {id:'L1_SPO2', priority:95, when:{spo2Lt:92}, out:{level:1, reason:'血氧低於 92%'}},
    {id:'L2_FEVER', priority:80, when:{sym:['S_FEVER'], tempGt:39}, out:{level:2, reason:'高燒風險（建議24–48小時就醫）'}},
    {id:'L2_HIGH_RISK', priority:70, when:{severityGte:2, hasComorb:true}, out:{level:2, reason:'中重度症狀 + 背景慢病風險'}},
    {id:'L3_MODERATE', priority:50, when:{severityGte:2}, out:{level:3, reason:'中度症狀，建議1–2週內門診追蹤'}},
    {id:'L4_OBS', priority:10, when:{}, out:{level:4, reason:'可先自我照護並觀察'}}
  ],
  departmentMap: {
    S_CHEST_PAIN:['急診','心臟內科','家醫科'], S_PALPITATION:['心臟內科','家醫科'], S_SOB:['胸腔內科','急診','家醫科'],
    S_COUGH:['胸腔內科','家醫科'], S_ABD_PAIN:['腸胃科','家醫科'], S_DIARRHEA:['腸胃科','家醫科'], S_CONSTIPATION:['腸胃科','家醫科'],
    S_DIZZINESS:['神經內科','家醫科'], S_HEADACHE:['神經內科','家醫科'], S_NUMBNESS:['神經內科','家醫科'],
    S_URINE_PAIN:['泌尿科','腎臟科'], S_BLOOD_URINE:['泌尿科','腎臟科'], S_RASH:['皮膚科','家醫科'],
    S_JOINT_SWELL:['骨科','復健科','風濕免疫科'], S_SLEEP_ISSUE:['身心科','家醫科'], S_ANXIETY:['身心科','家醫科']
  },
  dietTags: {
    GI: {do:['白粥/吐司/蒸蛋','少量多餐','電解質補充'], avoid:['油炸辛辣','咖啡','過甜乳製品']},
    CV: {do:['低鹽','多蔬果','優質蛋白'], avoid:['高鈉加工品','泡麵','含糖飲料']},
    DEFAULT: {do:['補充水分','清淡飲食','規律作息'], avoid:['酒精','油炸辛辣','含糖飲料']}
  }
};

function renderChecks(id, dict){
  const el=document.getElementById(id);
  el.innerHTML=Object.entries(dict).map(([k,v])=>`<label class="chip"><input type="checkbox" value="${k}" data-group="${id}"> ${v}<span class="sub" style="margin-left:4px">(${k})</span></label>`).join('');
}
renderChecks('redFlags', Object.fromEntries(RULES_CONFIG.redFlagIds.map(id=>[id, RULES_CONFIG.symptomDict[id]])));
renderChecks('symptoms', RULES_CONFIG.symptomDict);
renderChecks('comorbids', RULES_CONFIG.comorbDict);

function checked(group){ return [...document.querySelectorAll(`input[data-group="${group}"]:checked`)].map(x=>x.value); }
function levelClass(l){return l===1?'lv1':l===2?'lv2':l===3?'lv3':'lv4'}

function run(){
  const red = checked('redFlags');
  const sym = checked('symptoms');
  const comorb = checked('comorbids');
  const sev = Number(document.getElementById('severity').value||2);
  const temp = Number(document.getElementById('temp').value||0);
  const spo2 = Number(document.getElementById('spo2').value||100);

  const ctx = { redFlag: red.length>0, spo2, sym, severity: sev, hasComorb: comorb.length>0, temp };

  let chosen = {out:{level:4, reason:'可先自我照護並觀察'}};
  for(const r of [...RULES_CONFIG.levelRules].sort((a,b)=>b.priority-a.priority)){
    const w = r.when || {};
    const ok =
      (w.redFlag===undefined || w.redFlag===ctx.redFlag) &&
      (w.spo2Lt===undefined || (ctx.spo2>0 && ctx.spo2 < w.spo2Lt)) &&
      (w.sym===undefined || w.sym.some(id=>ctx.sym.includes(id))) &&
      (w.tempGt===undefined || ctx.temp > w.tempGt) &&
      (w.hasComorb===undefined || w.hasComorb===ctx.hasComorb) &&
      (w.severityGte===undefined || ctx.severity >= w.severityGte);
    if(ok){ chosen = r; break; }
  }

  const level = chosen.out.level;
  const reasons = [chosen.out.reason];

  const deptSet = new Set(['家醫科']);
  sym.forEach(id => (RULES_CONFIG.departmentMap[id]||[]).forEach(d=>deptSet.add(d)));
  if(level===1) deptSet.add('急診');
  const dept = [...deptSet].slice(0,4);

  let diet = RULES_CONFIG.dietTags.DEFAULT;
  if(sym.some(id=>['S_NAUSEA','S_VOMIT','S_DIARRHEA','S_ABD_PAIN'].includes(id))) diet = RULES_CONFIG.dietTags.GI;
  if(sym.some(id=>['S_CHEST_PAIN','S_PALPITATION'].includes(id)) || comorb.includes('C_HTN')) diet = RULES_CONFIG.dietTags.CV;

  const levelText = {
    1:'Level 1：立即急診 / 必要時叫救護車',
    2:'Level 2：24–48 小時內就醫',
    3:'Level 3：1–2 週內門診追蹤',
    4:'Level 4：自我照護與觀察'
  };

  document.getElementById('r1').innerHTML = `<h3 class="section-title">卡片1：風險分級</h3><div class="result-level ${levelClass(level)}">${levelText[level]}</div><div>主要觸發原因：<ul>${reasons.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
  document.getElementById('r2').innerHTML = `<h3 class="section-title">卡片2：建議就醫科別</h3><div>首選科別：<b>${dept[0]||'家醫科'}</b></div><div>次選：${dept.slice(1).join('、')||'家醫科'}</div><div class="sub">規則鏈：症狀ID → 科別映射。</div>`;
  document.getElementById('r3').innerHTML = `<h3 class="section-title">卡片3：飲食注意</h3><div>今天先做：<ul>${diet.do.map(x=>`<li>${x}</li>`).join('')}</ul></div><div>先避免：<ul>${diet.avoid.map(x=>`<li>${x}</li>`).join('')}</ul></div>`;
  document.getElementById('r4').innerHTML = `<h3 class="section-title">卡片4：觀察清單</h3><ul><li>體溫/血壓/心率/血氧</li><li>排尿量與補水狀況</li><li>症狀是否加重（24小時內）</li></ul><div class="sub">若出現紅旗警訊，請立即就醫。</div>`;
  document.getElementById('status').textContent = '分析完成（JSON 規則引擎模式）。';
}

document.getElementById('runBtn').addEventListener('click', run);
</script>
</body>
</html>
